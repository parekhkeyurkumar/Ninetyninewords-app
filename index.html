<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Your day in ninety-nine words. One less than perfect, just like life.">
  <title>NinetyNine Words</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìî</text></svg>">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 0;
      padding-top: 80px; /* Space for fixed header on mobile */
    }

    .container {
      max-width: 700px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      z-index: 998;
      transition: box-shadow 0.3s ease;
    }

    .header.scrolled {
      box-shadow: 0 4px 16px rgba(0,0,0,0.15);
    }

    .header-content {
      max-width: 700px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      padding: 16px 20px;
      gap: 16px;
    }

    .header-branding {
      flex: 1;
      text-align: center;
    }
    
    h1 {
      color: #333;
      font-size: 20px;
      margin: 0;
      font-weight: 700;
    }

    .tagline {
      color: #666;
      font-size: 13px;
      margin-top: 4px;
      display: none; /* Hidden on mobile by default */
    }

    .tagline strong {
      color: #764ba2;
    }

    /* Integrated Hamburger Button */
    .hamburger-btn {
      background: transparent;
      border: none;
      font-size: 24px;
      cursor: pointer;
      padding: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #666;
      transition: all 0.2s;
      border-radius: 8px;
      min-width: 40px;
      height: 40px;
    }

    .hamburger-btn:hover {
      background: rgba(102, 126, 234, 0.1);
      color: #667eea;
    }

    .hamburger-btn:active {
      transform: scale(0.95);
    }

    /* Desktop styles */
    @media (min-width: 768px) {
      body {
        padding-top: 120px; /* More space for taller desktop header */
      }

      .header-content {
        padding: 24px 20px;
      }

      h1 {
        font-size: 28px;
      }

      .tagline {
        display: block; /* Show taglines on desktop */
        font-size: 14px;
      }
    }
    
    .write-section {
      background: white;
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    .search-section {
      background: white;
      padding: 20px 30px;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    .search-container {
      position: relative;
      display: flex;
      align-items: center;
    }

    .search-icon {
      position: absolute;
      left: 15px;
      font-size: 18px;
      pointer-events: none;
      color: #999;
    }

    #searchInput {
      width: 100%;
      padding: 12px 45px 12px 45px;
      font-size: 16px;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      font-family: inherit;
      transition: border-color 0.3s;
    }

    #searchInput:focus {
      outline: none;
      border-color: #667eea;
    }

    .clear-search {
      position: absolute;
      right: 15px;
      background: #f0f0f0;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      font-size: 14px;
      cursor: pointer;
      display: none;
      align-items: center;
      justify-content: center;
      color: #666;
      transition: all 0.2s;
    }

    .clear-search:hover {
      background: #e0e0e0;
      color: #333;
    }

    .clear-search.visible {
      display: flex;
    }

    .search-results {
      margin-top: 10px;
      font-size: 14px;
      color: #666;
      font-weight: 500;
    }

    .search-results.no-results {
      color: #f5576c;
    }

    .mood-selector {
      margin-bottom: 20px;
      text-align: center;
    }

    .mood-label {
      font-size: 14px;
      color: #666;
      margin-bottom: 10px;
      font-weight: 600;
    }

    .mood-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .mood-btn {
      font-size: 32px;
      padding: 10px 15px;
      border: 3px solid #e0e0e0;
      border-radius: 12px;
      background: white;
      cursor: pointer;
      transition: all 0.2s;
    }

    .mood-btn:hover {
      transform: scale(1.1);
      border-color: #667eea;
    }

    .mood-btn.selected {
      border-color: #667eea;
      background: #f0f4ff;
      transform: scale(1.15);
    }
    
    textarea { 
      width: 100%; 
      height: 150px; 
      font-size: 16px; 
      padding: 15px;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      font-family: inherit;
      resize: vertical;
      transition: border-color 0.3s;
    }
    
    textarea:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .word-count { 
      color: #666; 
      margin-top: 8px;
      font-size: 14px;
    }
    
    .warning { 
      color: #f5576c;
      font-weight: bold;
    }
    
    .save-btn { 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white; 
      padding: 14px 35px; 
      border: none; 
      border-radius: 12px; 
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 15px;
      transition: transform 0.2s, box-shadow 0.2s;
      width: 100%;
    }
    
    .save-btn:hover { 
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
    }
    
    .save-btn:active {
      transform: translateY(0);
    }
    
    .entries { 
      margin-top: 20px;
    }
    
    .entries-header {
      background: white;
      padding: 20px 30px;
      border-radius: 16px;
      margin-bottom: 15px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    }
    
    .entries-header h2 {
      color: #333;
      font-size: 24px;
    }
    
    .entry { 
      background: white;
      padding: 25px; 
      margin: 15px 0; 
      border-radius: 16px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.08);
      border-left: 5px solid #667eea;
      transition: transform 0.2s;
    }
    
    .entry:hover {
      transform: translateX(5px);
    }
    
    .entry-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      flex-wrap: wrap;
      gap: 10px;
    }

    .entry-date { 
      color: #999; 
      font-size: 13px; 
      font-weight: 600;
    }

    .entry-mood {
      font-size: 28px;
      margin-right: 15px;
      cursor: help;
      flex-shrink: 0;
    }

    .edit-btn {
      background: #667eea;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .edit-btn:hover {
      background: #764ba2;
      transform: scale(1.05);
    }

    .delete-btn {
      background: #ff4757;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .delete-btn:hover {
      background: #ee5a6f;
      transform: scale(1.05);
    }

    .save-edit-btn {
      background: #10ac84;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .save-edit-btn:hover {
      background: #0e9770;
      transform: scale(1.05);
    }

    .cancel-edit-btn {
      background: #999;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .cancel-edit-btn:hover {
      background: #777;
      transform: scale(1.05);
    }

    .entry.editing {
      border-left-color: #10ac84;
    }

    .entry-edit-textarea {
      width: 100%;
      min-height: 100px;
      font-size: 15px;
      padding: 12px;
      border: 2px solid #667eea;
      border-radius: 8px;
      font-family: inherit;
      resize: vertical;
      margin-bottom: 10px;
    }

    .entry-edit-textarea:focus {
      outline: none;
      border-color: #764ba2;
    }

    .entry-edit-word-count {
      font-size: 13px;
      color: #666;
      margin-bottom: 10px;
    }

    .entry-edit-word-count.warning {
      color: #f5576c;
      font-weight: bold;
    }

    .entry-mood-selector {
      margin-bottom: 15px;
    }

    .entry-mood-label {
      font-size: 13px;
      color: #666;
      margin-bottom: 8px;
      font-weight: 600;
    }

    .entry-mood-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .entry-mood-btn {
      font-size: 24px;
      padding: 6px 10px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      background: white;
      cursor: pointer;
      transition: all 0.2s;
    }

    .entry-mood-btn:hover {
      transform: scale(1.1);
      border-color: #667eea;
    }

    .entry-mood-btn.selected {
      border-color: #667eea;
      background: #f0f4ff;
      transform: scale(1.1);
    }
    
    .entry-text {
      color: #333;
      line-height: 1.6;
      font-size: 15px;
    }
    
    .no-entries {
      background: white;
      padding: 40px;
      border-radius: 16px;
      text-align: center;
      color: #999;
      font-style: italic;
    }

    .footer {
      text-align: center;
      color: white;
      padding: 20px;
      opacity: 0.8;
      font-size: 14px;
      margin-top: 40px;
    }

    /* Old hamburger styles removed - now integrated in header */

    /* Sidebar */
    .sidebar {
      position: fixed;
      top: 0;
      left: -280px;
      width: 280px;
      height: 100vh;
      background: white;
      box-shadow: 2px 0 20px rgba(0, 0, 0, 0.1);
      z-index: 1001;
      transition: left 0.3s ease;
      display: flex;
      flex-direction: column;
    }

    .sidebar.open {
      left: 0;
    }

    .sidebar-header {
      padding: 30px 20px 20px;
      border-bottom: 1px solid #e0e0e0;
    }

    .sidebar-logo {
      font-size: 24px;
      font-weight: 700;
      color: #333;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .sidebar-close {
      position: absolute;
      top: 20px;
      right: 20px;
      background: #f0f0f0;
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #666;
      transition: all 0.2s;
    }

    .sidebar-close:hover {
      background: #e0e0e0;
      color: #333;
      transform: scale(1.1);
    }

    .sidebar-nav {
      flex: 1;
      padding: 20px 0;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px 24px;
      color: #666;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
    }

    .nav-item:hover {
      background: #f5f5f5;
      color: #333;
    }

    .nav-item.active {
      background: #f0f4ff;
      color: #667eea;
      border-left: 4px solid #667eea;
      padding-left: 20px;
    }

    .nav-item-icon {
      font-size: 20px;
    }

    .sidebar-footer {
      padding: 20px;
      border-top: 1px solid #e0e0e0;
      text-align: center;
      color: #999;
      font-size: 13px;
      font-style: italic;
    }

    /* Backdrop */
    .backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100vh;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    .backdrop.visible {
      opacity: 1;
      visibility: visible;
    }

    /* View sections */
    .view-section {
      display: none;
    }

    .view-section.active {
      display: block;
    }

    /* Insights view */
    .insights-view {
      padding-bottom: 40px;
    }

    .insights-placeholder {
      font-size: 48px;
      margin-bottom: 20px;
    }

    .insights-text {
      font-size: 20px;
      color: #666;
      font-weight: 500;
    }

    .insights-empty {
      background: white;
      padding: 60px 40px;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
      text-align: center;
    }

    .insights-empty-icon {
      font-size: 64px;
      margin-bottom: 16px;
    }

    .insights-empty-text {
      font-size: 18px;
      color: #666;
      line-height: 1.6;
    }

    /* Time filter */
    .time-filter {
      background: white;
      padding: 20px 30px;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      display: flex;
      justify-content: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .filter-btn {
      padding: 10px 20px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      background: white;
      color: #666;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .filter-btn:hover {
      border-color: #667eea;
      color: #667eea;
    }

    .filter-btn.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-color: transparent;
    }

    /* Insights sections */
    .insights-section {
      background: white;
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    .insights-section h3 {
      font-size: 20px;
      color: #333;
      margin-bottom: 20px;
      font-weight: 700;
    }

    .summary-text {
      font-size: 18px;
      color: #667eea;
      line-height: 1.7;
      font-weight: 500;
      text-align: center;
    }

    .mood-bar-container {
      margin-bottom: 12px;
    }

    .mood-bar-label {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
      font-size: 15px;
      color: #333;
      font-weight: 500;
    }

    .mood-bar-emoji {
      font-size: 20px;
    }

    .mood-bar-wrapper {
      background: #f0f0f0;
      border-radius: 8px;
      height: 32px;
      overflow: hidden;
      position: relative;
    }

    .mood-bar {
      height: 100%;
      display: flex;
      align-items: center;
      padding: 0 12px;
      color: white;
      font-size: 13px;
      font-weight: 600;
      transition: width 0.5s ease;
      border-radius: 8px;
    }

    .mood-footer {
      margin-top: 16px;
      font-size: 15px;
      color: #666;
      font-style: italic;
      text-align: center;
    }

    .insight-text {
      font-size: 15px;
      color: #555;
      line-height: 1.7;
      margin-bottom: 10px;
    }

    .insight-highlight {
      color: #667eea;
      font-weight: 600;
    }

    .word-bar-container {
      margin-top: 20px;
      padding: 16px;
      background: #f8f8f8;
      border-radius: 12px;
    }

    .word-bar-item {
      margin-bottom: 12px;
    }

    .word-bar-item:last-child {
      margin-bottom: 0;
    }

    .word-bar-label {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 6px;
      font-size: 14px;
    }

    .word-bar-mood {
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 500;
      color: #333;
    }

    .word-bar-value {
      color: #666;
      font-size: 13px;
    }

    .word-bar-wrapper {
      background: #e0e0e0;
      border-radius: 6px;
      height: 20px;
      overflow: hidden;
    }

    .word-bar-fill {
      height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      transition: width 0.5s ease;
      border-radius: 6px;
    }

    .week-chart {
      display: flex;
      gap: 8px;
      justify-content: space-between;
      margin-top: 20px;
      padding: 20px 16px;
      background: #f8f8f8;
      border-radius: 12px;
    }

    .week-day {
      flex: 1;
      text-align: center;
    }

    .week-day-label {
      font-size: 12px;
      color: #666;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .week-day-bar {
      background: #e0e0e0;
      border-radius: 6px;
      height: 80px;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      position: relative;
    }

    .week-day-fill {
      width: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 6px;
      transition: height 0.5s ease;
      position: relative;
    }

    .week-day-count {
      position: absolute;
      top: -20px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 11px;
      font-weight: 600;
      color: #667eea;
    }

    .kind-message {
      background: #f0f4ff;
      border: 2px solid #d0dbff;
      border-radius: 12px;
      padding: 16px 20px;
      margin-top: 16px;
      font-size: 15px;
      color: #667eea;
      font-weight: 500;
      text-align: center;
    }

    @media (max-width: 500px) {
      .insights-section {
        padding: 24px 20px;
      }

      .insights-section h3 {
        font-size: 18px;
      }

      .summary-text {
        font-size: 16px;
      }

      .week-chart {
        padding: 16px 12px;
      }

      .week-day-label {
        font-size: 11px;
      }

      .filter-btn {
        font-size: 14px;
        padding: 8px 16px;
      }
    }

    /* Streak Counter */
    .streak-counter {
      background: linear-gradient(135deg, rgba(255, 183, 77, 0.1) 0%, rgba(255, 152, 0, 0.1) 100%);
      border: 2px solid rgba(255, 152, 0, 0.2);
      border-radius: 12px;
      padding: 16px 24px;
      margin-bottom: 25px;
      text-align: center;
      transition: all 0.3s ease;
    }

    .streak-counter.pulse {
      animation: streakPulse 0.6s ease-out;
    }

    @keyframes streakPulse {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.05);
        box-shadow: 0 5px 20px rgba(255, 152, 0, 0.3);
      }
    }

    .streak-text {
      font-size: 18px;
      font-weight: 600;
      color: #e65100;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    @media (max-width: 500px) {
      .streak-text {
        font-size: 16px;
      }
    }
  </style>
</head>
<body>
  <!-- Unified Sticky Header -->
  <div class="header" id="stickyHeader">
    <div class="header-content">
      <button class="hamburger-btn" onclick="toggleSidebar()" aria-label="Menu">‚ò∞</button>
      <div class="header-branding">
        <h1>üìî NinetyNine Words</h1>
        <p class="tagline">Your day in ninety-nine words.<br><strong>One less than perfect, just like life.</strong></p>
      </div>
    </div>
  </div>

  <!-- Backdrop -->
  <div class="backdrop" onclick="closeSidebar()"></div>

  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-logo">üìì NinetyNine Words</div>
      <button class="sidebar-close" onclick="closeSidebar()">‚úï</button>
    </div>
    <nav class="sidebar-nav">
      <button class="nav-item active" onclick="switchView('capture', event)">
        <span class="nav-item-icon">‚úèÔ∏è</span>
        <span>Capture</span>
      </button>
      <button class="nav-item" onclick="switchView('insights', event)">
        <span class="nav-item-icon">üìä</span>
        <span>Insights</span>
      </button>
    </nav>
    <div class="sidebar-footer">
      Write less. Remember more.
    </div>
  </div>

  <div class="container">
    <!-- Capture View (Default) -->
    <div class="view-section active" id="captureView">

      <div class="write-section">
      <!-- Streak Counter -->
      <div class="streak-counter" id="streakCounter">
        <div class="streak-text">
          <span id="streakMessage">Start your streak today! üî•</span>
        </div>
      </div>

      <div class="mood-selector">
        <div class="mood-label">Pick your mood</div>
        <div class="mood-buttons">
          <button type="button" class="mood-btn" data-mood="üòä" onclick="selectMood('üòä', event)" title="Happy">üòä</button>
          <button type="button" class="mood-btn" data-mood="ü§î" onclick="selectMood('ü§î', event)" title="Thoughtful">ü§î</button>
          <button type="button" class="mood-btn" data-mood="üòê" onclick="selectMood('üòê', event)" title="Neutral">üòê</button>
          <button type="button" class="mood-btn" data-mood="üò¥" onclick="selectMood('üò¥', event)" title="Tired">üò¥</button>
          <button type="button" class="mood-btn" data-mood="üò§" onclick="selectMood('üò§', event)" title="Angry">üò§</button>
          <button type="button" class="mood-btn" data-mood="üò¢" onclick="selectMood('üò¢', event)" title="Sad">üò¢</button>
        </div>
      </div>

      <textarea id="diaryEntry" placeholder="What's worth remembering today?"></textarea>
      <div class="word-count" id="wordCount">0 / 99 words</div>
      <button class="save-btn" onclick="saveEntry()">üìå Keep it</button>
    </div>

    <div class="search-section">
      <div class="search-container">
        <span class="search-icon">üîç</span>
        <input
          type="text"
          id="searchInput"
          placeholder="Find a memory..."
          oninput="handleSearch()"
        />
        <button class="clear-search" id="clearSearch" onclick="clearSearch()">‚úï</button>
      </div>
      <div class="search-results" id="searchResults"></div>
    </div>

      <div class="entries" id="entriesList"></div>
    </div>

    <!-- Insights View -->
    <div class="view-section" id="insightsView">
      <div class="insights-view" id="insightsContainer">
        <!-- Content will be dynamically generated -->
      </div>
    </div>

    <div class="footer">
      Write less. Remember more.
    </div>
  </div>

  <script>
    let selectedMood = null;
    let editingEntryId = null;
    let editingMood = null;
    let currentView = 'capture';

    // Calculate current streak
    function calculateStreak() {
      const entries = JSON.parse(localStorage.getItem('diaryEntries') || '[]');

      if (entries.length === 0) {
        return { streak: 0, hasEntryToday: false, hasEntryYesterday: false };
      }

      // Get all unique dates (YYYY-MM-DD format in local time)
      const uniqueDates = new Set();
      entries.forEach(entry => {
        const date = new Date(entry.timestamp);
        const dateStr = date.getFullYear() + '-' +
                       String(date.getMonth() + 1).padStart(2, '0') + '-' +
                       String(date.getDate()).padStart(2, '0');
        uniqueDates.add(dateStr);
      });

      // Convert to sorted array (most recent first)
      const sortedDates = Array.from(uniqueDates).sort().reverse();

      // Get today's date string
      const today = new Date();
      const todayStr = today.getFullYear() + '-' +
                      String(today.getMonth() + 1).padStart(2, '0') + '-' +
                      String(today.getDate()).padStart(2, '0');

      // Get yesterday's date string
      const yesterday = new Date(today);
      yesterday.setDate(yesterday.getDate() - 1);
      const yesterdayStr = yesterday.getFullYear() + '-' +
                          String(yesterday.getMonth() + 1).padStart(2, '0') + '-' +
                          String(yesterday.getDate()).padStart(2, '0');

      const hasEntryToday = sortedDates.includes(todayStr);
      const hasEntryYesterday = sortedDates.includes(yesterdayStr);

      // Calculate streak
      let streak = 0;
      const startDate = hasEntryToday ? todayStr : yesterdayStr;

      // If no entry today or yesterday, streak is broken
      if (!hasEntryToday && !hasEntryYesterday) {
        return { streak: 0, hasEntryToday: false, hasEntryYesterday: false };
      }

      // Count consecutive days
      // Parse date string as local time to avoid timezone issues
      const [startYear, startMonth, startDay] = startDate.split('-').map(Number);
      let checkDate = new Date(startYear, startMonth - 1, startDay);

      while (true) {
        const checkDateStr = checkDate.getFullYear() + '-' +
                            String(checkDate.getMonth() + 1).padStart(2, '0') + '-' +
                            String(checkDate.getDate()).padStart(2, '0');

        if (sortedDates.includes(checkDateStr)) {
          streak++;
          checkDate.setDate(checkDate.getDate() - 1);
        } else {
          break;
        }
      }

      return { streak, hasEntryToday, hasEntryYesterday };
    }

    // Update streak display
    function updateStreakDisplay(animate = false) {
      const { streak, hasEntryToday, hasEntryYesterday } = calculateStreak();
      const messageEl = document.getElementById('streakMessage');
      const counterEl = document.getElementById('streakCounter');

      let message = '';

      if (streak === 0) {
        // No entries ever
        message = 'Start your streak today!';
      } else if (!hasEntryToday && hasEntryYesterday) {
        // Wrote yesterday but not today
        message = `üî• ${streak} day${streak !== 1 ? 's' : ''} ‚Äî keep it going!`;
      } else if (hasEntryToday) {
        // Wrote today
        if (streak === 99) {
          message = 'üî• 99 days! One less than perfect!';
        } else if (streak === 1) {
          message = 'üî• 1 day streak!';
        } else if (streak === 7) {
          message = 'üî• 1 week strong!';
        } else if (streak === 30) {
          message = 'üî• 1 month strong!';
        } else if (streak >= 60 && streak % 30 === 0) {
          const months = Math.floor(streak / 30);
          message = `üî• ${months} months strong!`;
        } else {
          message = `üî• ${streak} day${streak !== 1 ? 's' : ''}!`;
        }
      }

      messageEl.textContent = message;

      // Add pulse animation if requested
      if (animate) {
        counterEl.classList.remove('pulse');
        // Force reflow to restart animation
        void counterEl.offsetWidth;
        counterEl.classList.add('pulse');

        setTimeout(() => {
          counterEl.classList.remove('pulse');
        }, 600);
      }
    }

    // Scroll shadow effect for sticky header
    window.addEventListener('scroll', function() {
      const header = document.getElementById('stickyHeader');
      if (window.scrollY > 10) {
        header.classList.add('scrolled');
      } else {
        header.classList.remove('scrolled');
      }
    });

    // Sidebar functions
    function toggleSidebar() {
      const sidebar = document.querySelector('.sidebar');
      const backdrop = document.querySelector('.backdrop');
      sidebar.classList.toggle('open');
      backdrop.classList.toggle('visible');
    }

    function closeSidebar() {
      const sidebar = document.querySelector('.sidebar');
      const backdrop = document.querySelector('.backdrop');
      sidebar.classList.remove('open');
      backdrop.classList.remove('visible');
    }

    // View switching
    function switchView(viewName, event) {
      currentView = viewName;

      // Hide all views
      document.querySelectorAll('.view-section').forEach(view => {
        view.classList.remove('active');
      });

      // Show selected view
      if (viewName === 'capture') {
        document.getElementById('captureView').classList.add('active');
      } else if (viewName === 'insights') {
        document.getElementById('insightsView').classList.add('active');
        // Render insights when switching to insights tab
        renderInsights();
      }

      // Update nav items
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
      });
      event.target.closest('.nav-item').classList.add('active');

      // Close sidebar
      closeSidebar();
    }

    // Mood to placeholder mapping
    const moodPlaceholders = {
      'üòä': "What made you smile?",
      'ü§î': "What's on your mind?",
      'üòê': "Even ordinary days matter.",
      'üò¥': "Too tired to talk? Type instead.",
      'üò§': "Let it out. No judgement.",
      'üò¢': "Want to get it off your chest?"
    };

    // Mood to name mapping for tooltips
    const moodNames = {
      'üòä': "Happy",
      'ü§î': "Thoughtful",
      'üòê': "Neutral",
      'üò¥': "Tired",
      'üò§': "Angry",
      'üò¢': "Sad"
    };

    const defaultPlaceholder = "What's worth remembering today?";

    // Select mood when user clicks emoji
    function selectMood(mood, event) {
      selectedMood = mood;

      document.querySelectorAll('.mood-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      event.target.classList.add('selected');

      // Update textarea placeholder based on selected mood
      const textarea = document.getElementById('diaryEntry');
      textarea.placeholder = moodPlaceholders[mood] || defaultPlaceholder;
    }

    // Handle search input
    function handleSearch() {
      const searchInput = document.getElementById('searchInput');
      const clearBtn = document.getElementById('clearSearch');
      const query = searchInput.value.trim();

      // Show/hide clear button
      if (query) {
        clearBtn.classList.add('visible');
      } else {
        clearBtn.classList.remove('visible');
      }

      // Filter and display entries
      displayEntries(query);
    }

    // Clear search
    function clearSearch() {
      document.getElementById('searchInput').value = '';
      document.getElementById('clearSearch').classList.remove('visible');
      document.getElementById('searchResults').textContent = '';
      displayEntries();
    }

    // Escape HTML to prevent XSS
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Highlight search terms in text
    function highlightText(text, query) {
      if (!query) return escapeHtml(text);

      // Escape the text first
      const escapedText = escapeHtml(text);
      const escapedQuery = escapeHtml(query);

      // Then highlight the query
      const regex = new RegExp(`(${escapedQuery.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
      return escapedText.replace(regex, '<mark style="background-color: #fff176; padding: 2px 0; border-radius: 2px;">$1</mark>');
    }

    // Count words as user types
    document.getElementById('diaryEntry').addEventListener('input', function() {
      const text = this.value.trim();
      const words = text === '' ? 0 : text.split(/\s+/).length;
      const counter = document.getElementById('wordCount');
      
      if (words > 99) {
        counter.classList.add('warning');
        counter.textContent = words + ' / 99 words - Too many words!';
      } else {
        counter.classList.remove('warning');
        counter.textContent = words + ' / 99 words';
      }
    });

    // Save entry to localStorage
    function saveEntry() {
      const text = document.getElementById('diaryEntry').value.trim();
      const words = text === '' ? 0 : text.split(/\s+/).length;
      
      // Validation
      if (text === '') {
        alert('‚úçÔ∏è Write something first!');
        return;
      }
      
      if (words > 99) {
        alert('üìù Please keep it under 99 words!');
        return;
      }

      if (!selectedMood) {
        alert('üòä Pick a mood first!');
        return;
      }
      
      // Get existing entries
      let entries = JSON.parse(localStorage.getItem('diaryEntries') || '[]');
      
      // Create new entry
      const newEntry = {
        id: Date.now(),
        text: text,
        mood: selectedMood,
        timestamp: new Date().toISOString(),
        date: new Date().toLocaleString('en-US', { 
          weekday: 'short',
          year: 'numeric', 
          month: 'short', 
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        }),
        words: words
      };
      
      // Add to beginning of array
      entries.unshift(newEntry);
      
      // Save to localStorage
      localStorage.setItem('diaryEntries', JSON.stringify(entries));
      
      // Clear form
      const textarea = document.getElementById('diaryEntry');
      textarea.value = '';
      textarea.placeholder = defaultPlaceholder;
      document.getElementById('wordCount').textContent = '0 / 99 words';
      selectedMood = null;
      document.querySelectorAll('.mood-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      
      // Refresh display
      displayEntries();

      // Update streak counter with animation
      updateStreakDisplay(true);

      alert('‚úÖ Entry saved successfully!');
    }

    // Edit entry
    function editEntry(id) {
      // Prevent editing multiple entries at once
      if (editingEntryId !== null && editingEntryId !== id) {
        alert('‚ö†Ô∏è Please save or cancel the current edit first!');
        return;
      }

      editingEntryId = id;
      const entries = JSON.parse(localStorage.getItem('diaryEntries') || '[]');
      const entry = entries.find(e => e.id === id);

      if (!entry) return;

      editingMood = entry.mood;
      displayEntries();
    }

    // Select mood for entry being edited
    function selectEditMood(mood, entryId, event) {
      editingMood = mood;

      // Update button states
      document.querySelectorAll(`[data-entry-mood-btn="${entryId}"]`).forEach(btn => {
        btn.classList.remove('selected');
      });
      event.target.classList.add('selected');
    }

    // Update word count for entry being edited
    function updateEditWordCount(entryId) {
      const textarea = document.getElementById(`edit-textarea-${entryId}`);
      const counter = document.getElementById(`edit-word-count-${entryId}`);

      const text = textarea.value.trim();
      const words = text === '' ? 0 : text.split(/\s+/).length;

      if (words > 99) {
        counter.classList.add('warning');
        counter.textContent = words + ' / 99 words - Too many words!';
      } else {
        counter.classList.remove('warning');
        counter.textContent = words + ' / 99 words';
      }
    }

    // Save edited entry
    function saveEdit(id) {
      const textarea = document.getElementById(`edit-textarea-${id}`);
      const text = textarea.value.trim();
      const words = text === '' ? 0 : text.split(/\s+/).length;

      // Validation
      if (text === '') {
        alert('‚úçÔ∏è Entry cannot be empty!');
        return;
      }

      if (words > 99) {
        alert('üìù Please keep it under 99 words!');
        return;
      }

      if (!editingMood) {
        alert('üòä Pick a mood!');
        return;
      }

      // Get existing entries
      let entries = JSON.parse(localStorage.getItem('diaryEntries') || '[]');

      // Find and update the entry
      const entryIndex = entries.findIndex(e => e.id === id);
      if (entryIndex !== -1) {
        entries[entryIndex].text = text;
        entries[entryIndex].mood = editingMood;
        entries[entryIndex].words = words;
      }

      // Save to localStorage
      localStorage.setItem('diaryEntries', JSON.stringify(entries));

      // Reset editing state
      editingEntryId = null;
      editingMood = null;

      // Refresh display
      displayEntries();

      // Update streak counter (no animation for edits)
      updateStreakDisplay();

      alert('‚úÖ Entry updated successfully!');
    }

    // Cancel edit
    function cancelEdit() {
      editingEntryId = null;
      editingMood = null;
      displayEntries();
    }

    // Delete entry
    function deleteEntry(id) {
      if (!confirm('Are you sure you want to delete this entry?')) {
        return;
      }

      let entries = JSON.parse(localStorage.getItem('diaryEntries') || '[]');
      entries = entries.filter(entry => entry.id !== id);
      localStorage.setItem('diaryEntries', JSON.stringify(entries));

      displayEntries();

      // Update streak counter (deleting might break the streak)
      updateStreakDisplay();

      alert('üóëÔ∏è Entry deleted!');
    }

    // Display all entries
    function displayEntries(searchQuery = '') {
      const allEntries = JSON.parse(localStorage.getItem('diaryEntries') || '[]');
      const container = document.getElementById('entriesList');
      const searchResultsDiv = document.getElementById('searchResults');

      // Filter entries based on search query
      let entries = allEntries;
      if (searchQuery) {
        entries = allEntries.filter(entry =>
          entry.text.toLowerCase().includes(searchQuery.toLowerCase())
        );
      }

      // Update search results message
      if (searchQuery) {
        if (entries.length === 0) {
          searchResultsDiv.textContent = 'No entries match your search';
          searchResultsDiv.classList.add('no-results');
        } else {
          searchResultsDiv.textContent = `${entries.length} result${entries.length !== 1 ? 's' : ''} found`;
          searchResultsDiv.classList.remove('no-results');
        }
      } else {
        searchResultsDiv.textContent = '';
        searchResultsDiv.classList.remove('no-results');
      }

      if (allEntries.length === 0) {
        container.innerHTML = `
          <div class="no-entries">
            Your first 99 words start here.
          </div>
        `;
        return;
      }

      if (entries.length === 0 && searchQuery) {
        container.innerHTML = `
          <div class="entries-header">
            <h2>üìÖ Your Days</h2>
          </div>
          <div class="no-entries">
            No entries match your search. Try different keywords!
          </div>
        `;
        return;
      }

      container.innerHTML = `
        <div class="entries-header">
          <h2>üìÖ Your Days</h2>
        </div>
      ` + entries.map(entry => {
        const isEditing = editingEntryId === entry.id;

        if (isEditing) {
          // Edit mode
          return `
            <div class="entry editing">
              <div class="entry-header">
                <div>
                  <div class="entry-date">${entry.date}</div>
                </div>
              </div>
              <div class="entry-mood-selector">
                <div class="entry-mood-label">Pick your mood</div>
                <div class="entry-mood-buttons">
                  <button type="button" class="entry-mood-btn ${editingMood === 'üòä' ? 'selected' : ''}" data-entry-mood-btn="${entry.id}" onclick="selectEditMood('üòä', ${entry.id}, event)">üòä</button>
                  <button type="button" class="entry-mood-btn ${editingMood === 'ü§î' ? 'selected' : ''}" data-entry-mood-btn="${entry.id}" onclick="selectEditMood('ü§î', ${entry.id}, event)">ü§î</button>
                  <button type="button" class="entry-mood-btn ${editingMood === 'üòê' ? 'selected' : ''}" data-entry-mood-btn="${entry.id}" onclick="selectEditMood('üòê', ${entry.id}, event)">üòê</button>
                  <button type="button" class="entry-mood-btn ${editingMood === 'üò¥' ? 'selected' : ''}" data-entry-mood-btn="${entry.id}" onclick="selectEditMood('üò¥', ${entry.id}, event)">üò¥</button>
                  <button type="button" class="entry-mood-btn ${editingMood === 'üò§' ? 'selected' : ''}" data-entry-mood-btn="${entry.id}" onclick="selectEditMood('üò§', ${entry.id}, event)">üò§</button>
                  <button type="button" class="entry-mood-btn ${editingMood === 'üò¢' ? 'selected' : ''}" data-entry-mood-btn="${entry.id}" onclick="selectEditMood('üò¢', ${entry.id}, event)">üò¢</button>
                </div>
              </div>
              <textarea
                id="edit-textarea-${entry.id}"
                class="entry-edit-textarea"
                oninput="updateEditWordCount(${entry.id})"
              >${entry.text}</textarea>
              <div id="edit-word-count-${entry.id}" class="entry-edit-word-count">${entry.words} / 99 words</div>
              <div style="display: flex; gap: 10px;">
                <button class="save-edit-btn" onclick="saveEdit(${entry.id})">üíæ Save</button>
                <button class="cancel-edit-btn" onclick="cancelEdit()">‚úñÔ∏è Cancel</button>
              </div>
            </div>
          `;
        } else {
          // Normal display mode
          return `
            <div class="entry">
              <div class="entry-header">
                ${entry.mood ? `<span class="entry-mood" title="${moodNames[entry.mood] || ''}">${entry.mood}</span>` : ''}
                <div style="flex: 1;">
                  <div class="entry-date">${entry.date} ‚Ä¢ ${entry.words} words</div>
                </div>
                <div style="display: flex; align-items: center; gap: 10px;">
                  <button class="edit-btn" onclick="editEntry(${entry.id})">‚úèÔ∏è Edit</button>
                  <button class="delete-btn" onclick="deleteEntry(${entry.id})">üóëÔ∏è Delete</button>
                </div>
              </div>
              <div class="entry-text">${highlightText(entry.text, searchQuery)}</div>
            </div>
          `;
        }
      }).join('');
    }

    // Insights functionality
    let currentTimeFilter = 'all'; // 'week', 'month', 'all'

    // Mood colors
    const moodColors = {
      'üòä': '#F59E0B', // Happy - warm yellow/gold
      'ü§î': '#3B82F6', // Thoughtful - blue
      'üòê': '#6B7280', // Neutral - gray
      'üò¥': '#8B5CF6', // Tired - purple
      'üò§': '#EF4444', // Angry - red/orange
      'üò¢': '#06B6D4'  // Sad - light blue
    };

    // Mood scores for positivity calculation
    const moodScores = {
      'üòä': 5,
      'ü§î': 4,
      'üòê': 3,
      'üò¥': 2,
      'üò§': 1,
      'üò¢': 1
    };

    // Filter entries by time period
    function filterEntriesByTime(entries, filter) {
      if (filter === 'all') return entries;

      const now = new Date();
      const cutoffDate = new Date();

      if (filter === 'week') {
        cutoffDate.setDate(now.getDate() - 7);
      } else if (filter === 'month') {
        cutoffDate.setDate(now.getDate() - 30);
      }

      return entries.filter(entry => new Date(entry.timestamp) >= cutoffDate);
    }

    // Set time filter
    function setTimeFilter(filter) {
      currentTimeFilter = filter;
      renderInsights();
    }

    // Generate personalized summary sentence
    function generateSummary(entries) {
      if (entries.length === 0) return null;

      // Count moods
      const moodCounts = {};
      entries.forEach(entry => {
        moodCounts[entry.mood] = (moodCounts[entry.mood] || 0) + 1;
      });

      // Find most common mood
      let mostCommonMood = null;
      let maxCount = 0;
      for (const [mood, count] of Object.entries(moodCounts)) {
        if (count > maxCount) {
          maxCount = count;
          mostCommonMood = mood;
        }
      }

      // Analyze day patterns
      const dayCounts = {};
      entries.forEach(entry => {
        const day = new Date(entry.timestamp).toLocaleDateString('en-US', { weekday: 'long' });
        dayCounts[day] = (dayCounts[day] || 0) + 1;
      });

      let mostActiveDay = null;
      let maxDayCount = 0;
      for (const [day, count] of Object.entries(dayCounts)) {
        if (count > maxDayCount) {
          maxDayCount = count;
          mostActiveDay = day;
        }
      }

      // Generate summary based on patterns
      const summaries = [];

      // Mood-based summaries
      const moodPercentage = Math.round((maxCount / entries.length) * 100);
      const timeframe = currentTimeFilter === 'week' ? 'this week' : currentTimeFilter === 'month' ? 'this month' : 'overall';

      if (mostCommonMood === 'üòä' && moodPercentage >= 40) {
        summaries.push(`You've been feeling mostly ${mostCommonMood} Happy ${timeframe}, especially on ${mostActiveDay}s!`);
      } else if (mostCommonMood === 'ü§î' && moodPercentage >= 35) {
        summaries.push(`Looks like a reflective ${currentTimeFilter === 'week' ? 'week' : 'period'} ‚Äî you've been ${mostCommonMood} Thoughtful more than usual.`);
      } else if (mostCommonMood === 'üò¥' && moodPercentage >= 30) {
        summaries.push(`${currentTimeFilter === 'week' ? 'Tough week?' : 'Feeling tired lately?'} You logged ${mostCommonMood} Tired a few times. Hope you're getting rest!`);
      } else if (mostCommonMood === 'üò¢' && moodPercentage >= 25) {
        summaries.push(`It's been a heavy ${currentTimeFilter === 'week' ? 'week' : 'time'} ‚Äî remember, it's okay to feel ${mostCommonMood} Sad.`);
      } else if (mostCommonMood === 'üò§' && moodPercentage >= 25) {
        summaries.push(`You've been ${mostCommonMood} Angry more than usual ‚Äî journaling is a great outlet!`);
      } else if (mostActiveDay && maxDayCount >= 3) {
        summaries.push(`You write the most on ${mostActiveDay}s ‚Äî that's your reflection day!`);
      } else {
        summaries.push(`You've captured ${entries.length} moment${entries.length !== 1 ? 's' : ''} ${timeframe} ‚Äî nice work! üìù`);
      }

      return summaries[0];
    }

    // Calculate mood breakdown
    function calculateMoodBreakdown(entries) {
      const moodCounts = {};
      entries.forEach(entry => {
        moodCounts[entry.mood] = (moodCounts[entry.mood] || 0) + 1;
      });

      // Convert to array and sort by count
      const breakdown = Object.entries(moodCounts).map(([mood, count]) => ({
        mood,
        name: moodNames[mood],
        count,
        percentage: Math.round((count / entries.length) * 100)
      })).sort((a, b) => b.count - a.count);

      return breakdown;
    }

    // Analyze word patterns
    function analyzeWordPatterns(entries) {
      if (entries.length === 0) return null;

      const avgWords = Math.round(entries.reduce((sum, e) => sum + e.words, 0) / entries.length);
      const longest = entries.reduce((max, e) => e.words > max.words ? e : max, entries[0]);
      const shortest = entries.reduce((min, e) => e.words < min.words ? e : min, entries[0]);

      // Calculate average words per mood
      const moodWords = {};
      const moodCounts = {};
      entries.forEach(entry => {
        if (!moodWords[entry.mood]) {
          moodWords[entry.mood] = 0;
          moodCounts[entry.mood] = 0;
        }
        moodWords[entry.mood] += entry.words;
        moodCounts[entry.mood]++;
      });

      const moodAverages = Object.entries(moodWords).map(([mood, total]) => ({
        mood,
        name: moodNames[mood],
        avg: Math.round(total / moodCounts[mood]),
        count: moodCounts[mood]
      })).filter(m => m.count >= 3).sort((a, b) => b.avg - a.avg);

      return { avgWords, longest, shortest, moodAverages };
    }

    // Analyze week patterns
    function analyzeWeekPatterns(entries) {
      if (entries.length === 0) return null;

      const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
      const dayCounts = {};
      const dayMoods = {};

      dayNames.forEach(day => {
        dayCounts[day] = 0;
        dayMoods[day] = {};
      });

      entries.forEach(entry => {
        const day = dayNames[new Date(entry.timestamp).getDay()];
        dayCounts[day]++;
        dayMoods[day][entry.mood] = (dayMoods[day][entry.mood] || 0) + 1;
      });

      // Find most active day
      let mostActiveDay = null;
      let maxCount = 0;
      for (const [day, count] of Object.entries(dayCounts)) {
        if (count > maxCount) {
          maxCount = count;
          mostActiveDay = day;
        }
      }

      // Find happiest day (most Happy moods)
      let happiestDay = null;
      let maxHappyCount = 0;
      for (const [day, moods] of Object.entries(dayMoods)) {
        const happyCount = moods['üòä'] || 0;
        if (happyCount > maxHappyCount) {
          maxHappyCount = happyCount;
          happiestDay = day;
        }
      }

      // Find toughest day (most Angry/Sad moods)
      let toughestDay = null;
      let maxToughCount = 0;
      for (const [day, moods] of Object.entries(dayMoods)) {
        const toughCount = (moods['üò§'] || 0) + (moods['üò¢'] || 0);
        if (toughCount > maxToughCount && toughCount >= 2) {
          maxToughCount = toughCount;
          toughestDay = day;
        }
      }

      return {
        dayCounts,
        mostActiveDay,
        happiestDay: maxHappyCount >= 2 ? happiestDay : null,
        toughestDay
      };
    }

    // Analyze time of day patterns
    function analyzeTimePatterns(entries) {
      if (entries.length === 0) return null;

      const timeBuckets = {
        'Morning': 0,    // 5am - 12pm
        'Afternoon': 0,  // 12pm - 5pm
        'Evening': 0,    // 5pm - 9pm
        'Night': 0       // 9pm - 5am
      };

      const timeMoods = {
        'Morning': {},
        'Afternoon': {},
        'Evening': {},
        'Night': {}
      };

      entries.forEach(entry => {
        const hour = new Date(entry.timestamp).getHours();
        let bucket;

        if (hour >= 5 && hour < 12) bucket = 'Morning';
        else if (hour >= 12 && hour < 17) bucket = 'Afternoon';
        else if (hour >= 17 && hour < 21) bucket = 'Evening';
        else bucket = 'Night';

        timeBuckets[bucket]++;
        timeMoods[bucket][entry.mood] = (timeMoods[bucket][entry.mood] || 0) + 1;
      });

      // Find most active time
      let mostActiveTime = null;
      let maxCount = 0;
      for (const [time, count] of Object.entries(timeBuckets)) {
        if (count > maxCount) {
          maxCount = count;
          mostActiveTime = time;
        }
      }

      // Find dominant mood for that time
      let dominantMood = null;
      if (mostActiveTime) {
        let maxMoodCount = 0;
        for (const [mood, count] of Object.entries(timeMoods[mostActiveTime])) {
          if (count > maxMoodCount) {
            maxMoodCount = count;
            dominantMood = mood;
          }
        }
      }

      return {
        mostActiveTime,
        dominantMood: maxCount >= 3 ? dominantMood : null,
        timeBuckets
      };
    }

    // Analyze streak impact on mood
    function analyzeStreakImpact(entries) {
      if (entries.length < 5) return null;

      // Get streak dates
      const { streak } = calculateStreak();
      if (streak === 0) return null;

      const streakDates = new Set();
      const today = new Date();

      for (let i = 0; i < streak; i++) {
        const date = new Date(today);
        date.setDate(date.getDate() - i);
        const dateStr = date.getFullYear() + '-' +
                       String(date.getMonth() + 1).padStart(2, '0') + '-' +
                       String(date.getDate()).padStart(2, '0');
        streakDates.add(dateStr);
      }

      // Calculate average mood score for streak days vs non-streak days
      let streakMoodSum = 0;
      let streakCount = 0;
      let nonStreakMoodSum = 0;
      let nonStreakCount = 0;

      entries.forEach(entry => {
        const date = new Date(entry.timestamp);
        const dateStr = date.getFullYear() + '-' +
                       String(date.getMonth() + 1).padStart(2, '0') + '-' +
                       String(date.getDate()).padStart(2, '0');

        const score = moodScores[entry.mood] || 3;

        if (streakDates.has(dateStr)) {
          streakMoodSum += score;
          streakCount++;
        } else {
          nonStreakMoodSum += score;
          nonStreakCount++;
        }
      });

      if (streakCount === 0 || nonStreakCount === 0) return null;

      const streakAvg = streakMoodSum / streakCount;
      const nonStreakAvg = nonStreakMoodSum / nonStreakCount;
      const improvement = Math.round(((streakAvg - nonStreakAvg) / nonStreakAvg) * 100);

      return {
        improvement,
        isPositive: improvement > 5
      };
    }

    // Format date nicely
    function formatNiceDate(timestamp) {
      const date = new Date(timestamp);
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    // Render insights dashboard
    function renderInsights() {
      const allEntries = JSON.parse(localStorage.getItem('diaryEntries') || '[]');
      const filteredEntries = filterEntriesByTime(allEntries, currentTimeFilter);
      const container = document.getElementById('insightsContainer');

      // Empty state
      if (allEntries.length === 0) {
        container.innerHTML = `
          <div class="insights-empty">
            <div class="insights-empty-icon">‚ú®</div>
            <div class="insights-empty-text">Your insights will appear here. Start with your first 99 words!</div>
          </div>
        `;
        return;
      }

      if (allEntries.length <= 2) {
        container.innerHTML = `
          <div class="insights-empty">
            <div class="insights-empty-icon">üìù</div>
            <div class="insights-empty-text">A few more entries and we'll spot some patterns... keep going!</div>
          </div>
        `;
        return;
      }

      if (allEntries.length <= 4) {
        container.innerHTML = `
          <div class="insights-empty">
            <div class="insights-empty-icon">üîì</div>
            <div class="insights-empty-text">Patterns emerging! Write a couple more to unlock deeper insights</div>
          </div>
        `;
        return;
      }

      // Check if filtered entries are empty
      if (filteredEntries.length === 0) {
        container.innerHTML = `
          <div class="time-filter">
            <button class="filter-btn ${currentTimeFilter === 'week' ? 'active' : ''}" onclick="setTimeFilter('week')">This Week</button>
            <button class="filter-btn ${currentTimeFilter === 'month' ? 'active' : ''}" onclick="setTimeFilter('month')">This Month</button>
            <button class="filter-btn ${currentTimeFilter === 'all' ? 'active' : ''}" onclick="setTimeFilter('all')">All Time</button>
          </div>
          <div class="insights-empty">
            <div class="insights-empty-icon">üìÖ</div>
            <div class="insights-empty-text">No entries in this time period. Try a different filter!</div>
          </div>
        `;
        return;
      }

      // Calculate all insights
      const summary = generateSummary(filteredEntries);
      const moodBreakdown = calculateMoodBreakdown(filteredEntries);
      const wordPatterns = analyzeWordPatterns(filteredEntries);
      const weekPatterns = analyzeWeekPatterns(filteredEntries);
      const timePatterns = analyzeTimePatterns(filteredEntries);
      const streakImpact = analyzeStreakImpact(filteredEntries);

      // Build HTML
      let html = `
        <!-- Time Filter -->
        <div class="time-filter">
          <button class="filter-btn ${currentTimeFilter === 'week' ? 'active' : ''}" onclick="setTimeFilter('week')">This Week</button>
          <button class="filter-btn ${currentTimeFilter === 'month' ? 'active' : ''}" onclick="setTimeFilter('month')">This Month</button>
          <button class="filter-btn ${currentTimeFilter === 'all' ? 'active' : ''}" onclick="setTimeFilter('all')">All Time</button>
        </div>

        <!-- Summary -->
        ${summary ? `
        <div class="insights-section">
          <div class="summary-text">${summary}</div>
        </div>
        ` : ''}

        <!-- Mood Breakdown -->
        <div class="insights-section">
          <h3>How You've Been Feeling</h3>
          ${moodBreakdown.map((item, index) => {
            const widthPercent = index === 0 ? 100 : (item.percentage / moodBreakdown[0].percentage) * 100;
            return `
              <div class="mood-bar-container">
                <div class="mood-bar-label">
                  <span class="mood-bar-emoji">${item.mood}</span>
                  <span>${item.name}</span>
                </div>
                <div class="mood-bar-wrapper">
                  <div class="mood-bar" style="width: ${widthPercent}%; background-color: ${moodColors[item.mood]};">
                    ${item.percentage}% (${item.count} ${item.count === 1 ? 'entry' : 'entries'})
                  </div>
                </div>
              </div>
            `;
          }).join('')}
          <div class="mood-footer">Your most common mood is ${moodBreakdown[0].mood} ${moodBreakdown[0].name}</div>
        </div>

        <!-- Your 99 Pattern -->
        ${wordPatterns ? `
        <div class="insights-section">
          <h3>Your 99 Pattern ‚úçÔ∏è</h3>
          <div class="insight-text">
            On average, you use <span class="insight-highlight">${wordPatterns.avgWords}</span> of your 99 words
          </div>
          <div class="insight-text">
            Your longest entry was <span class="insight-highlight">${wordPatterns.longest.words} words</span> on ${formatNiceDate(wordPatterns.longest.timestamp)}
          </div>
          <div class="insight-text">
            Your shortest entry was <span class="insight-highlight">${wordPatterns.shortest.words} words</span> on ${formatNiceDate(wordPatterns.shortest.timestamp)}
          </div>

          ${wordPatterns.moodAverages.length > 0 ? `
            <div class="word-bar-container">
              ${wordPatterns.moodAverages.slice(0, 3).map(item => {
                const widthPercent = (item.avg / 99) * 100;
                let message = '';
                if (item.mood === 'üò§') {
                  message = 'venting helps!';
                } else if (item.mood === 'üò¢') {
                  message = 'and that's okay';
                } else if (item.mood === 'üòä') {
                  message = 'when happy!';
                } else if (item.mood === 'ü§î') {
                  message = 'deep thoughts!';
                } else {
                  message = 'on average';
                }

                return `
                  <div class="word-bar-item">
                    <div class="word-bar-label">
                      <div class="word-bar-mood">
                        <span>${item.mood}</span>
                        <span>${item.name}</span>
                      </div>
                      <div class="word-bar-value">${item.avg} words ‚Äî ${message}</div>
                    </div>
                    <div class="word-bar-wrapper">
                      <div class="word-bar-fill" style="width: ${widthPercent}%;"></div>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          ` : '<div class="kind-message">Write a few more entries in different moods to see word patterns!</div>'}
        </div>
        ` : ''}

        <!-- Your Week Pattern -->
        ${weekPatterns && weekPatterns.mostActiveDay ? `
        <div class="insights-section">
          <h3>Your Week üìÖ</h3>
          ${weekPatterns.mostActiveDay ? `<div class="insight-text">You write most on <span class="insight-highlight">${weekPatterns.mostActiveDay}s</span></div>` : ''}
          ${weekPatterns.happiestDay ? `<div class="insight-text">Your happiest day tends to be <span class="insight-highlight">${weekPatterns.happiestDay} üòä</span></div>` : ''}
          ${weekPatterns.toughestDay ? `<div class="insight-text">Your toughest day is usually <span class="insight-highlight">${weekPatterns.toughestDay}</span></div>` : ''}

          <div class="week-chart">
            ${['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'].map((dayShort, index) => {
              const fullDays = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
              const count = weekPatterns.dayCounts[fullDays[index]] || 0;
              const maxCount = Math.max(...Object.values(weekPatterns.dayCounts));
              const heightPercent = maxCount > 0 ? (count / maxCount) * 100 : 0;

              return `
                <div class="week-day">
                  <div class="week-day-label">${dayShort}</div>
                  <div class="week-day-bar">
                    ${count > 0 ? `
                      <div class="week-day-fill" style="height: ${heightPercent}%;">
                        <div class="week-day-count">${count}</div>
                      </div>
                    ` : ''}
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
        ` : `
        <div class="insights-section">
          <h3>Your Week üìÖ</h3>
          <div class="kind-message">Write a few more entries to see your weekly rhythm!</div>
        </div>
        `}

        <!-- When You Write -->
        ${timePatterns && timePatterns.mostActiveTime ? `
        <div class="insights-section">
          <h3>When You Write üïê</h3>
          <div class="insight-text">
            Most of your entries are in the <span class="insight-highlight">${timePatterns.mostActiveTime.toLowerCase()}</span>
          </div>
          ${timePatterns.dominantMood ? `
            <div class="insight-text">
              Your ${timePatterns.mostActiveTime.toLowerCase()} entries tend to be <span class="insight-highlight">${timePatterns.dominantMood} ${moodNames[timePatterns.dominantMood]}</span>
            </div>
          ` : ''}
          ${timePatterns.mostActiveTime === 'Night' && timePatterns.dominantMood ? `
            <div class="kind-message">You're a night owl! Most entries are after 9pm${timePatterns.dominantMood === 'üò¥' || timePatterns.dominantMood === 'ü§î' ? ', and they're often reflective or tired' : ''}</div>
          ` : ''}
        </div>
        ` : `
        <div class="insights-section">
          <h3>When You Write üïê</h3>
          <div class="kind-message">Keep writing and we'll learn when inspiration strikes!</div>
        </div>
        `}

        <!-- Streak Impact -->
        ${streakImpact ? `
        <div class="insights-section">
          <h3>Does Writing Help? üî•</h3>
          ${streakImpact.isPositive ? `
            <div class="insight-text">
              On days you kept your streak, you were <span class="insight-highlight">${Math.abs(streakImpact.improvement)}% more likely</span> to feel happier!
            </div>
            <div class="kind-message">Writing consistently seems to boost your mood ‚Äî keep it up!</div>
          ` : `
            <div class="insight-text">Keep building your streak to see if writing helps your mood!</div>
            <div class="kind-message">The more you write, the clearer the patterns become üìà</div>
          `}
        </div>
        ` : ''}
      `;

      container.innerHTML = html;
    }

    // Load entries when page loads
    displayEntries();
    updateStreakDisplay();
  </script>
</body>
</html>
